#!/usr/bin/python
# coding=utf-8

"""
   命令行处理差异工具
"""
import os
from docopt import docopt
from turbo.fake import project_template as pt

SERVER = 'test'
APP = 'test'

def build_project():
    os.mkdir(os.path.join('.', project))
    curr = os.path.abspath(os.path.join('.', project))
    copies = []
    for root, dirs, files in os.walk(fdir, topdown):
        for d in dirs:
            path = ''.join([curr, root.replace(fdir, ''), '/', d])
            if not os.path.exists(path):
                os.makedirs(path)
                
        path = ''.join([curr, root.replace(fdir, '')])
        flag = True
        for f in files:
            name = None
            if not f.endswith('.py'):
                continue
            if f.startswith('html_'):
                name = f.replace('html_', '').replace('.py', '.html')
            if (name or f).startswith('test_'):
                name = (name or f).replace('test_', '')
                childpath = ''.join([path, '/', app])
                if not os.path.exists(childpath):
                    os.makedirs(childpath)
                    copies.append(''.join([childpath, '/__init__.py']))
                # os.system('cp %s %s' % (''.join([root, '/', f]), ''.join([childpath, '/', name])))
                copies.append((''.join([root, '/', f]), ''.join([childpath, '/', name])))
            else:
                if f == '__init__.py':
                    flag = False
                # os.system('cp %s %s' % (''.join([root, '/', f]), ''.join([path, '/', name or f])))
                copies.append((''.join([root, '/', f]), ''.join([path, '/', name or f])))
        if flag and not path.endswith('/templates'):
            copies.append(''.join([path, '/__init__.py']))
    for one in copies:
        if type(one) == tuple:
            fromfi = open(one[0], 'r')
            datas = fromfi.read()
            fromfi.close()
            tofi = open(one[1], 'w')
            datas = tofi.write(datas.replace('{{test}}', app))
            tofi.close()
        else:
            fi = open(one, 'w')
            fi.write('')
            fi.close()
    pass


def build_server():
    pass


def build_app():
    pass



if __name__ == '__main__':
    project_path = os.path.dirname(pt.__file__)
    helpdoc = """turbo init project, server or app.
    Usage:
      turbo-admin (-h | --help)
      turbo-admin startproject  <project>
      turbo-admin startserver   <server>
      turbo-admin startapp      <app>

    Options:
      -h,  --help        Show help document
    """
    rgs = docopt(helpdoc)
    if rgs.get('startproject'):
        project = rgs.get('<project>')
        if project:
            build_project(fdir, project_path, project, server, app)
        else:
            print "Please use 'turbo -h'"

    if rgs.get('startserver'):
        print "Please use 'turbo -h'"

    if rgs.get('startapp'):
        print "Please use 'turbo -h'"